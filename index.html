<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Lịch công tác VKSND TP.Cần Thơ</title>
    <style>
        body { font-family: "Times New Roman", Times, serif; background:#f4f7f6; margin:0; padding:20px; line-height: 1.4; color: black; }
        .no-print { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 5px solid #da251d; }
        .tab-box { display: flex; gap: 5px; margin: 15px 0; }
        .tab-item { flex: 1; padding: 12px; text-align: center; background: #e0e0e0; cursor: pointer; font-weight: bold; border-radius: 5px; border: 1px solid #ccc; font-size: 11pt; }
        .tab-item.active { background: #0056b3; color: white; border-color: #0056b3; }
        
        .print-page { width: 210mm; min-height: 297mm; padding: 20mm 10mm 20mm 25mm; margin: auto; background: white; box-sizing: border-box; font-size: 13pt; border: 1px solid #eee; position: relative; }
        .flex-header { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .header-left { width: 45%; text-align: center; white-space: nowrap; }
        .header-right { width: 55%; text-align: center; white-space: nowrap; }
        .title-bold { font-weight: bold; text-transform: uppercase; }
        
        .main-title { text-align: center; font-weight: bold; font-size: 15pt; margin: 20px 0 5px 0; text-transform: uppercase; }
        .sub-title { text-align: center; font-weight: bold; margin-bottom: 15px; }
        
        .day-block { margin-top: 20px; }
        .day-head { font-weight: bold; text-transform: uppercase; text-decoration: underline; margin-bottom: 5px; }
        .day-content { text-align: justify; margin-bottom: 10px; }
        .direct-item { margin-bottom: 3px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #ddd; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; font-family: "Times New Roman"; font-size: 11pt; box-sizing: border-box; }
        .full-width { grid-column: span 2; }
        .btn { padding: 10px 20px; background: #0056b3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-green { background: #28a745; }
        .btn-orange { background: #f0ad4e; }
        .warning { color: red; font-weight: bold; padding: 15px; background: #fff3f3; border: 1px solid #ffcccc; border-radius: 4px; margin: 10px 0; text-align: center; }
        
        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .print-page { border: none; margin: 0; width: 100%; box-shadow: none; }
        }
    </style>
</head>
<body>

<div id="loginSection" class="no-print" style="text-align:center; padding: 50px;">
    <h2 style="color:#da251d">VIỆN KIỂM SÁT NHÂN DÂN THÀNH PHỐ CẦN THƠ</h2>
    <div style="max-width: 350px; margin: auto; text-align: left;">
        <label>Đơn vị:</label>
        <select id="userSelect"></select>
        <label style="display:block; margin-top:10px;">Mật khẩu:</label>
        <input type="password" id="passInput" onkeyup="if(event.keyCode===13) login()">
        <button class="btn" style="width:100%; margin-top:15px;" onclick="login()">Đăng nhập</button>
    </div>
</div>

<div id="mainSection" class="no-print" style="display:none;">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <b id="userLabel" style="color:#0056b3"></b>
        <div>
            <button class="btn btn-orange" style="padding: 5px 10px;" onclick="changePassword()">Đổi mật khẩu</button>
            <button class="btn" style="background:#666; padding: 5px 10px;" onclick="location.reload()">Đăng xuất</button>
        </div>
    </div>

    <div class="tab-box">
        <div id="t-tuan" class="tab-item active" onclick="setTab('tuan')">LỊCH CÔNG TÁC</div>
        <div id="t-dem" class="tab-item" onclick="setTab('dem')">LỊCH TRỰC ĐÊM</div>
        <div id="t-cuoituan" class="tab-item" onclick="setTab('cuoituan')">LỊCH TRỰC THỨ 7, CN</div>
        <div id="t-le" class="tab-item" onclick="setTab('le')">LỊCH TRỰC LỄ, TẾT</div>
    </div>

    <div id="lockNotice" class="warning" style="display:none;">
        ⚠ Tài khoản của bạn chỉ có quyền xem và đăng ký "LỊCH CÔNG TÁC TUẦN". <br>Các loại lịch trực do Văn phòng Tổng hợp quản lý.
    </div>

    <div id="inputForm" class="form-grid">
        <div id="box-holiday-name" style="display:none;" class="full-width">
            <label>Tên dịp Lễ/Tết:</label>
            <input type="text" id="holidayName" placeholder="VD: TẾT NGUYÊN ĐÁN ẤT TỴ 2025">
        </div>
        <div>
            <label id="dateLabel">Ngày trực/Làm việc:</label>
            <select id="dateSelect"></select>
            <input type="text" id="customDate" style="display:none;" placeholder="VD: 25/01 (Thứ Bảy)">
        </div>
        <div id="box-time">
            <label>Thời gian:</label>
            <input type="text" id="timeInput" placeholder="Nhập giờ công tác">
        </div>
        
        <div class="full-width" id="directFields" style="display:none; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label>Trực Lãnh đạo:</label><input type="text" id="inp-ld"></div>
                <div><label>SĐT Lãnh đạo:</label><input type="text" id="tel-ld"></div>
                <div><label>Trực Trưởng ca:</label><input type="text" id="inp-tc"></div>
                <div><label>SĐT Trưởng ca:</label><input type="text" id="tel-tc"></div>
                <div><label>Trực Nghiệp vụ:</label><input type="text" id="inp-nv"></div>
                <div><label>SĐT Nghiệp vụ:</label><input type="text" id="tel-nv"></div>
                <div id="box-vp"><label>Trực Văn phòng:</label><input type="text" id="inp-vp"></div>
                <div id="box-tel-vp"><label>SĐT Văn phòng:</label><input type="text" id="tel-vp"></div>
                <div><label>Trực Lái xe:</label><input type="text" id="inp-lx"></div>
                <div><label>SĐT Lái xe:</label><input type="text" id="tel-lx"></div>
                <div class="full-width"><label>Trực Bảo vệ (Nhập tên cách nhau dấu phẩy):</label><input type="text" id="inp-bv"></div>
            </div>
        </div>

        <div class="full-width" id="box-content">
            <label>Nội dung công tác:</label>
            <textarea id="contentInput" rows="3"></textarea>
        </div>
        
        <div class="full-width" id="actionButtons" style="margin-top:10px;">
            <button class="btn" onclick="save()">Lưu cập nhật</button>
            <button class="btn btn-green" onclick="window.print()">Xuất bản in (PDF)</button>
            <button class="btn" style="float:right; background:#d9534f" id="btnDelete" onclick="clearDay()">Xóa ngày này</button>
        </div>
    </div>
</div>

<div class="print-page">
    <div class="flex-header">
        <div class="header-left">
            <div>VIỆN KIỂM SÁT NHÂN DÂN TỐI CAO</div>
            <div class="title-bold">VIỆN KIỂM SÁT NHÂN DÂN</div>
            <div class="title-bold">THÀNH PHỐ CẦN THƠ</div>
            <div id="docNum" style="margin-top:5px;">Số: 01/LCT</div>
            <div style="width: 60px; border-bottom: 1px solid black; margin: 2px auto;"></div>
        </div>
        <div class="header-right">
            <div class="title-bold">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
            <div class="title-bold" style="font-size: 13pt;">Độc lập - Tự do - Hạnh phúc</div>
            <div style="width: 160px; border-bottom: 1px solid black; margin: 2px auto;"></div>
            <div id="topDate" style="font-style: italic; margin-top: 8px;"></div>
        </div>
    </div>

    <div class="main-title" id="pTitle">LỊCH CÔNG TÁC TUẦN</div>
    <div class="sub-title" id="pRange"></div>
    <div id="pNote" style="text-align:center; font-style:italic; font-size: 11pt; margin-bottom: 15px; display:none;">
        (Theo Quy định số 01/QĐ-VKSTC ngày 09/01/2019 của VKSND tối cao)
    </div>

    <div id="scheduleBody"></div>

    <div style="margin-top: 30px; display: flex; justify-content: flex-end; text-align: center;">
        <div style="width: 300px;">
            <b id="s1">TL. VIỆN TRƯỞNG</b><br>
            <b id="s2">CHÁNH VĂN PHÒNG</b><br><br><br><br><br>
            <b id="s3">Vũ Phương Liên</b>
        </div>
    </div>
</div>

<script>
    const users = ["Văn phòng", "Viện trưởng", "Phó viện trưởng Lê Nguyễn Trường Sơn", "Phó viện trưởng Phạm Chi Lăng", "Phó viện trưởng Nguyễn Thanh Sang", "Phòng 1", "Phòng 2", "Phòng 7", "Phòng 8", "Phòng 9", "Phòng 10", "Phòng 11", "Phòng 15", "Thanh tra - Khiếu tố", "VKSND KV1", "VKSND KV2", "VKSND KV3", "VKSND KV4", "VKSND KV5", "VKSND KV6", "VKSND KV7", "VKSND KV8", "VKSND KV9", "VKSND KV10", "VKSND KV11", "VKSND KV12", "VKSND KV13", "VKSND KV14"];
    let currentTab = 'tuan'; let currentUser = "";
    
    // Khởi tạo dữ liệu bao gồm cả bảng mật khẩu
    let db = JSON.parse(localStorage.getItem('vks_master_v5')) || { 
        tuan: {}, dem: {}, cuoituan: {}, le: { data: {}, name: "" },
        passwords: {} // Lưu mật khẩu các đơn vị ở đây
    };
    
    const now = new Date();
    const monday = new Date(now); 
    monday.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
    const weekdays = [];
    for(let i=0; i<7; i++) {
        let d = new Date(monday); d.setDate(monday.getDate() + i);
        let name = (i==5?"Thứ Bảy":i==6?"Chủ Nhật":"Thứ " + ["Hai","Ba","Tư","Năm","Sáu"][i]);
        weekdays.push({ label: name, date: d.toLocaleDateString('vi-VN') });
    }

    window.onload = () => {
        const uSel = document.getElementById('userSelect');
        users.forEach(u => uSel.add(new Option(u, u)));
        document.getElementById('topDate').innerText = `Cần Thơ, ngày ${now.getDate()} tháng ${now.getMonth()+1} năm ${now.getFullYear()}`;
        setTab('tuan');
    };

    function login() {
        let selectedUser = document.getElementById('userSelect').value;
        let enteredPass = document.getElementById('passInput').value;
        let correctPass = db.passwords[selectedUser] || "vks123"; // Mặc định mật khẩu trống

        if (enteredPass === correctPass) {
            currentUser = selectedUser;
            document.getElementById('loginSection').style.display='none';
            document.getElementById('mainSection').style.display='block';
            document.getElementById('userLabel').innerText = "Đơn vị: " + currentUser;
            document.getElementById('passInput').value = ""; // Xóa pass sau khi đăng nhập
            setTab(currentTab);
        } else {
            alert("Mật khẩu không chính xác!");
        }
    }

    function changePassword() {
        let oldPass = prompt("Nhập mật khẩu hiện tại:");
        let currentSavedPass = db.passwords[currentUser] || "";

        if (oldPass === currentSavedPass) {
            let newPass = prompt("Nhập mật khẩu mới:");
            if (newPass !== null) {
                if (newPass.trim() === "") {
                    alert("Mật khẩu không được để trống!");
                    return;
                }
                db.passwords[currentUser] = newPass;
                localStorage.setItem('vks_master_v5', JSON.stringify(db));
                alert("Đã đổi mật khẩu thành công!");
            }
        } else {
            alert("Mật khẩu cũ không đúng!");
        }
    }

    function setTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
        document.getElementById('t-' + t).classList.add('active');
        
        const isVP = (currentUser === "Văn phòng");
        const isDirectTab = (t !== 'tuan');

        if (isDirectTab && !isVP) {
            document.getElementById('inputForm').style.display = 'none';
            document.getElementById('lockNotice').style.display = 'block';
        } else {
            document.getElementById('inputForm').style.display = 'grid';
            document.getElementById('lockNotice').style.display = 'none';
        }

        document.getElementById('directFields').style.display = isDirectTab ? 'block' : 'none';
        document.getElementById('box-time').style.display = isDirectTab ? 'none' : 'block';
        document.getElementById('box-content').style.display = isDirectTab ? 'none' : 'block';
        document.getElementById('pNote').style.display = isDirectTab ? 'block' : 'none';
        document.getElementById('box-vp').style.display = (t === 'cuoituan' || t === 'le') ? 'block' : 'none';
        document.getElementById('box-tel-vp').style.display = (t === 'cuoituan' || t === 'le') ? 'block' : 'none';
        document.getElementById('box-holiday-name').style.display = (t === 'le') ? 'block' : 'none';
        document.getElementById('btnDelete').style.display = isVP ? 'block' : 'none';

        const dSel = document.getElementById('dateSelect');
        const cDate = document.getElementById('customDate');
        if(t === 'le') {
            dSel.style.display = 'none'; cDate.style.display = 'block';
        } else {
            dSel.style.display = 'block'; cDate.style.display = 'none';
            dSel.innerHTML = "";
            if(t === 'cuoituan') { dSel.add(new Option(weekdays[5].label, 5)); dSel.add(new Option(weekdays[6].label, 6)); }
            else { const limit = (t==='dem'?5:7); for(let i=0; i<limit; i++) dSel.add(new Option(weekdays[i].label, i)); }
        }

        const titles = { 
            tuan: ["LỊCH CÔNG TÁC TUẦN", "LCT", "Vũ Phương Liên", "CHÁNH VĂN PHÒNG"],
            dem: ["THÔNG BÁO LỊCH TRỰC ĐÊM TUẦN", "TBLT-VKS-VP", "Vũ Phương Liên", "CHÁNH VĂN PHÒNG"],
            cuoituan: ["THÔNG BÁO LỊCH TRỰC THỨ BẢY, CHỦ NHẬT", "TBLT-VKS-VP", "Vũ Phương Liên", "CHÁNH VĂN PHÒNG"],
            le: ["THÔNG BÁO LỊCH TRỰC LỄ", "TB-VP", "Vũ Phương Liên", "CHÁNH VĂN PHÒNG"]
        };
        document.getElementById('pTitle').innerText = titles[t][0];
        document.getElementById('docNum').innerText = "Số: .../" + titles[t][1];
        document.getElementById('s3').innerText = titles[t][2];
        document.getElementById('s2').innerText = titles[t][3];
        render();
    }

    function save() {
        let d = (currentTab === 'le') ? document.getElementById('customDate').value : document.getElementById('dateSelect').value;
        if(currentTab === 'tuan') {
            if(!db.tuan[d]) db.tuan[d] = [];
            db.tuan[d].push({ u: currentUser, t: document.getElementById('timeInput').value, c: document.getElementById('contentInput').value });
        } else {
            db.le.name = document.getElementById('holidayName').value;
            let target = (currentTab === 'le') ? db.le.data : db[currentTab];
            target[d] = {
                ld: document.getElementById('inp-ld').value, tld: document.getElementById('tel-ld').value,
                tc: document.getElementById('inp-tc').value, ttc: document.getElementById('tel-tc').value,
                nv: document.getElementById('inp-nv').value, tnv: document.getElementById('tel-nv').value,
                vp: document.getElementById('inp-vp').value, tvp: document.getElementById('tel-vp').value,
                lx: document.getElementById('inp-lx').value, tlx: document.getElementById('tel-lx').value,
                bv: document.getElementById('inp-bv').value
            };
        }
        localStorage.setItem('vks_master_v5', JSON.stringify(db));
        render(); alert("Đã lưu!");
    }

    function render() {
        let h = "";
        if(currentTab === 'le') {
            document.getElementById('pTitle').innerText = db.le.name || "THÔNG BÁO LỊCH TRỰC LỄ";
            Object.keys(db.le.data).sort().forEach(day => h += renderDirectBlock(day.toUpperCase(), db.le.data[day]));
        } else {
            const list = currentTab === 'cuoituan' ? [5,6] : currentTab === 'dem' ? [0,1,2,3,4] : [0,1,2,3,4,5,6];
            document.getElementById('pRange').innerText = `(Từ ngày ${weekdays[list[0]].date} đến ngày ${weekdays[list[list.length-1]].date})`;
            list.forEach(i => {
                const data = db[currentTab][i];
                const dayHeader = `${weekdays[i].label.toUpperCase()} NGÀY ${weekdays[i].date}`;
                if(currentTab === 'tuan') {
                    let items = data || [];
                    let txt = items.length ? items.map(it => `${it.t ? it.t + ": " : ""}${it.c} (${it.u})`).join("\n") : "- Lãnh đạo Viện và các phòng nghiệp vụ làm việc bình thường.";
                    h += `<div class="day-block"><div class="day-head">${dayHeader}</div><div class="day-content" style="white-space:pre-line;">${txt}</div></div>`;
                } else h += renderDirectBlock(dayHeader, data);
            });
        }
        document.getElementById('scheduleBody').innerHTML = h;
    }

    function renderDirectBlock(title, data) {
        let html = `<div class="day-block"><div class="day-head">${title}</div>`;
        if(!data) html += `<div class="day-content">- Chưa có dữ liệu trực.</div></div>`;
        else {
            html += `<div class="day-content">
                <div class="direct-item"><b>Trực Lãnh đạo:</b> ${data.ld} - ĐT: ${data.tld}</div>
                <div class="direct-item"><b>Trực trưởng ca:</b> ${data.tc} - ĐT: ${data.ttc}</div>
                <div class="direct-item"><b>Trực nghiệp vụ:</b> ${data.nv} - ĐT: ${data.tnv}</div>`;
            if(data.vp) html += `<div class="direct-item"><b>Trực Văn phòng:</b> ${data.vp} - ĐT: ${data.tvp}</div>`;
            html += `<div class="direct-item"><b>Trực lái xe:</b> ${data.lx} - ĐT: ${data.tlx}</div>
                <div class="direct-item"><b>Trực bảo vệ:</b> ${data.bv.split(',').map(n => "Đ/c " + n.trim()).join(", ")}</div>
            </div></div>`;
        }
        return html;
    }

    function clearDay() { 
        let d = (currentTab === 'le') ? document.getElementById('customDate').value : document.getElementById('dateSelect').value;
        if(confirm("Xác nhận xóa dữ liệu ngày này?")) { 
            if(currentTab === 'le') delete db.le.data[d];
            else db[currentTab][d] = (currentTab==='tuan'?[]:null); 
            localStorage.setItem('vks_master_v5', JSON.stringify(db)); 
            render(); 
        } 
    }
</script>
</body>
</html>
